# 第3章 DNSサーバー構築

## 3.8 リゾルバの変更

リゾルバ(DNSクライアント)の設定を変更する。 
具体的には `/etc/resolv.conf` で定義されている参照するDNSサーバーのIPアドレスを変更する。  

変更する方法：  
- GUIで変更する
- `/etc/NetworkManager/system-connections/[NIC名].nmconnection` ファイルを編集する
- `nmcli` コマンドで変更する

`/etc/resolv.conf` を直接編集しても、サーバーを再起動するともとに戻ってしまいます。


### 3.8.1 名前解決の確認

参照するDNSサーバーが講師サーバーのIPアドレスになっていることを確認する。

受講者Aの仮想マシン

```Shell
[root@host1 ~]#
[root@host1 ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search alpha.jp
nameserver 192.168.1.10
[root@host1 ~]#
[root@host1 ~]# nmcli con show enp0s3 | grep ipv4.dns
ipv4.dns:                               192.168.1.10
ipv4.dns-search:                        --
ipv4.dns-options:                       --
ipv4.dns-priority:                      0
[root@host1 ~]#
```

受講者Bの仮想マシン

```Shell
[root@host2 ~]#
[root@host2 ~]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 192.168.1.10
[root@host2 ~]#
[root@host2 ~]# nmcli con show enp0s3 | grep ipv4.dns
ipv4.dns:                               192.168.1.10
ipv4.dns-search:                        --
ipv4.dns-options:                       --
ipv4.dns-priority:                      0
[root@host2 ~]#
```


受講者DNSサーバーの設定が適切に完了していれば講師DNSサーバーを経由して名前解決ができる。  

受講者Aの仮想マシン

```Shell
[root@host1 ~]#
[root@host1 ~]# host -t ns alpha.jp
alpha.jp name server host1.alpha.jp.
[root@host1 ~]#
[root@host1 ~]# host -t mx alpha.jp
alpha.jp mail is handled by 10 mail.alpha.jp.
[root@host1 ~]#
[root@host1 ~]# host -t ns beta.jp
beta.jp name server host1.beta.jp.
[root@host1 ~]#
[root@host1 ~]# host -t mx alpha.jp
alpha.jp mail is handled by 10 mail.alpha.jp.
[root@host1 ~]#
```

受講者Bの仮想マシン

```Shell
[root@host2 ~]#
[root@host2 ~]# host -t ns alpha.jp
alpha.jp name server host1.alpha.jp.
[root@host2 ~]#
[root@host2 ~]# host -t mx alpha.jp
alpha.jp mail is handled by 10 mail.alpha.jp.
[root@host2 ~]#
[root@host2 ~]#
[root@host2 ~]# host -t ns beta.jp
beta.jp name server host1.beta.jp.
[root@host2 ~]#
[root@host2 ~]# host -t mx beta.jp
beta.jp mail is handled by 10 mail.beta.jp.
[root@host2 ~]#
```


講師DNSサーバーが適切に設定されていればインターネットにあるホスト名も名前解決できる。  


受講者Aの仮想マシン

```Shell
[root@host1 ~]#
[root@host1 ~]# host www.yahoo.co.jp
www.yahoo.co.jp is an alias for edge12.g.yimg.jp.
edge12.g.yimg.jp has address 182.22.31.124
[root@host1 ~]#
[root@host1 ~]# dig www.yahoo.co.jp

; <<>> DiG 9.16.23-RH <<>> www.yahoo.co.jp
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27392
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;www.yahoo.co.jp.               IN      A

;; ANSWER SECTION:
www.yahoo.co.jp.        849     IN      CNAME   edge12.g.yimg.jp.
edge12.g.yimg.jp.       9       IN      A       182.22.31.124

;; Query time: 1 msec
;; SERVER: 192.168.1.10#53(192.168.1.10)
;; WHEN: Thu Sep 14 14:25:20 JST 2023
;; MSG SIZE  rcvd: 88

[root@host1 ~]#
[root@host1 ~]# nslookup www.yahoo.co.jp
Server:         192.168.1.10
Address:        192.168.1.10#53

Non-authoritative answer:
www.yahoo.co.jp canonical name = edge12.g.yimg.jp.
Name:   edge12.g.yimg.jp
Address: 182.22.31.124

[root@host1 ~]#
```

受講者Bの仮想マシン

```Shell
[root@host2 ~]#
[root@host2 ~]# host www.yahoo.co.jp
www.yahoo.co.jp is an alias for edge12.g.yimg.jp.
edge12.g.yimg.jp has address 183.79.250.251
[root@host2 ~]#
[root@host2 ~]# dig www.yahoo.co.jp

; <<>> DiG 9.16.23-RH <<>> www.yahoo.co.jp
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 28418
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;www.yahoo.co.jp.               IN      A

;; ANSWER SECTION:
www.yahoo.co.jp.        895     IN      CNAME   edge12.g.yimg.jp.
edge12.g.yimg.jp.       55      IN      A       182.22.31.124

;; Query time: 1 msec
;; SERVER: 192.168.1.10#53(192.168.1.10)
;; WHEN: Thu Sep 14 15:16:47 JST 2023
;; MSG SIZE  rcvd: 88

[root@host2 ~]#
[root@host2 ~]# nslookup www.yahoo.co.jp
Server:         192.168.1.10
Address:        192.168.1.10#53

Non-authoritative answer:
www.yahoo.co.jp canonical name = edge12.g.yimg.jp.
Name:   edge12.g.yimg.jp
Address: 182.22.31.124

[root@host2 ~]#
```
